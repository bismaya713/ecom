{% extends 'base.html' %}

{% block title %}
Home
{% endblock title %}

{% block content %}
    <h1>Welcome to dhamaka sale</h1>
{% endblock content %}

{% block body %}
{% load static %}
<section id="portfolio" class="portfolio">
  
    <div class="container">
      {% for message in messages %}
      <div class="alert alert-{{message.tags}} alert-dismissible fade show" role="alert">
        <strong>{{message}}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="btn-close"></button>
      </div>
      {% endfor %}
      <div class="section-title">
        <h2>Welcome to our shop</h2>
        <p><span>Check Our</span> <span class="description-title">Products</span></p>
    </div>

    {% for product, range, nSlides in allProds %}
    <h3 class="my-3 text-center text-success bg-light">{{ product.0.category }} Flash Sale</h3>
    <div class="container">
        <div class="row">
            {% for i in product %}
            <div class="col-md-3 mt-3">
                <img src="{{ i.image.url }}" alt="not found" class="card-img-top" height="200px" width="150px">
                <div class="card-body">
                    <h5 class="card-title mt-2" id="namepr{{ i.pk }}">{{ i.product_name }}</h5>
                    <p class="card-text">{{ i.desc|slice:"0:53" }}...</p>
                    <h6 class="card-title mb-3">Price:<span id="pricepr{{ i.pk }}">{{ i.price }}</span></h6>
                    
                    <!-- Ensure the divpr ID is unique using i.pk -->
                    <span class="divpr" id="divpr{{ i.pk }}">
                    {% if user.is_authenticated %}
                        <button class="btn btn-success btn-sm" onclick="addToCart('{{ i.pk }}')">Add To Cart</button>
                    {% else %}
                        <button class="btn btn-secondary btn-sm" disabled>Please log in to add to cart</button>
                    {% endif %}
                    </span>
    
                    <a href="{{ i.image.url }}" target="_blank">
                        <button class="btn btn-success btn-sm">View</button>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}    
    
    <script>
      function addToCart(productId) {
        fetch(`/add_to_cart/${productId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            // Update quantity and buttons
            document.getElementById('divpr' + productId).innerHTML = `
                <button class="btn btn-danger btn-sm" onclick="removeFromCart('${productId}')">-</button>
                <span id="quantity${productId}">${data.quantity}</span>
                <button class="btn btn-success btn-sm" onclick="addToCart('${productId}')">+</button>
            `;
        })
        .catch(error => {
            console.error("Error adding to cart:", error);
        });
    }

    // Remove from Cart Function
    function removeFromCart(productId) {
        fetch(`/remove_from_cart/${productId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.quantity > 0) {
                // Update quantity and buttons
                document.getElementById('divpr' + productId).innerHTML = `
                    <button class="btn btn-danger btn-sm" onclick="removeFromCart('${productId}')">-</button>
                    <span id="quantity${productId}">${data.quantity}</span>
                    <button class="btn btn-success btn-sm" onclick="addToCart('${productId}')">+</button>
                `;
            } else {
                // If quantity is 0, just show "Add to Cart" button again
                document.getElementById('divpr' + productId).innerHTML = `
                    <button class="btn btn-success btn-sm" onclick="addToCart('${productId}')">Add To Cart</button>
                `;
            }
        })
        .catch(error => {
            console.error("Error removing from cart:", error);
        });
      }
    </script>    
</section>


{% endblock body %}